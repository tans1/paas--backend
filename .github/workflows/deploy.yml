name: CI & Deploy

on:
  push:
    branches:
      - main

jobs:
  # Uncomment tests when ready
  # test:
  #   name: ðŸ§ª Run Tests
  #   runs-on: ubuntu-latest
  #   steps: [...]

  deploy:
    name: ðŸš€ Deploy to Remote
    # Uncomment when tests are enabled:
    # needs: test
    # if: ${{ needs.test.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Configure Git Credentials
        run: |
          git config --global credential.helper store
          echo "https://${{ secrets.GH_USER }}:${{ secrets.GH_TOKEN }}@github.com" > ~/.git-credentials

      - name: SSH & Deploy
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          ssh-strict: false
          script: |
            cd ~/final-year/paas--backend
            docker compose down
            git config --global --add safe.directory "$(pwd)"
            git pull origin main
            NODE_ENV=production docker compose up --build app -d